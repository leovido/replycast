# Database Queries Documentation

This document contains all the raw SQL queries used by the ReplyCast Mini App. These queries are generated by Drizzle ORM and executed against a PostgreSQL database.

## Database Schema

### Tables

- `casts` - Cast information (posts, replies)
- `profiles` - User profile information
- `links` - User relationships (follows, etc.)
- `reactions` - Cast reactions (likes, recasts)
- `verifications` - Wallet verifications

### Key Indexes

- `casts_hash_idx` on `casts(hash)`
- `casts_fid_idx` on `casts(fid)`
- `casts_parent_hash_idx` on `casts(parent_cast_hash)`
- `casts_timestamp_idx` on `casts(timestamp)`
- `reactions_target_cast_hash_idx` on `reactions(target_cast_hash)`
- `profiles_fid_idx` on `profiles(fid)`

## Raw SQL Queries

### 1. Main Query - Get Unreplied Conversations

**Purpose**: Get user's casts that have replies but user hasn't replied back
**Usage**: Primary query for the app's main functionality

```sql
-- Step 1: Get user's recent casts (root casts only)
SELECT * FROM casts
WHERE fid = $1 AND parent_cast_hash IS NULL
ORDER BY timestamp DESC
LIMIT $2;

-- Step 2: For each cast, check if it has replies (executed multiple times)
SELECT count(*) FROM casts
WHERE parent_cast_hash = $1
LIMIT 1;
```

**Parameters**:

- `$1`: User's FID (Farcaster ID)
- `$2`: Limit (typically 25)

**Performance Note**: This is a two-step process that can execute 25+ queries for a single API call.

### 2. Get Cast by Hash

**Purpose**: Retrieve a specific cast by its hash
**Usage**: Used for cursor-based pagination and cast lookups

```sql
SELECT * FROM casts
WHERE hash = $1
LIMIT 1;
```

**Parameters**:

- `$1`: Cast hash

### 3. Get Casts by Author (with pagination)

**Purpose**: Get user's casts with cursor-based pagination
**Usage**: Infinite scroll functionality

```sql
-- First, get cursor cast timestamp
SELECT * FROM casts
WHERE hash = $1
LIMIT 1;

-- Then get casts with cursor
SELECT * FROM casts
WHERE fid = $1 AND timestamp < $2
ORDER BY timestamp DESC
LIMIT $3;
```

**Parameters**:

- `$1`: User's FID
- `$2`: Cursor timestamp
- `$3`: Limit

### 4. Get Replies to Cast

**Purpose**: Get direct replies to a specific cast
**Usage**: Displaying conversation threads

```sql
SELECT * FROM casts
WHERE parent_cast_hash = $1
ORDER BY timestamp ASC
LIMIT $2;
```

**Parameters**:

- `$1`: Parent cast hash
- `$2`: Limit (typically 50)

### 5. Check if User Replied to Conversation

**Purpose**: Determine if user has replied to a conversation
**Usage**: Filtering unreplied conversations

```sql
SELECT * FROM casts
WHERE fid = $1 AND parent_cast_hash = $2
LIMIT 1;
```

**Parameters**:

- `$1`: User's FID
- `$2`: Root cast hash

### 6. Get Cast Reactions

**Purpose**: Get likes, recasts, and other reactions for a cast
**Usage**: Displaying engagement metrics

```sql
SELECT * FROM reactions
WHERE target_cast_hash = $1
ORDER BY timestamp DESC
LIMIT $2;
```

**Parameters**:

- `$1`: Cast hash
- `$2`: Limit (typically 100)

### 7. Get User Profile

**Purpose**: Retrieve user profile information
**Usage**: Displaying user details

```sql
SELECT * FROM profiles
WHERE fid = $1
LIMIT 1;
```

**Parameters**:

- `$1`: User's FID

### 8. Get Multiple Profiles

**Purpose**: Batch fetch multiple user profiles
**Usage**: Efficiently loading multiple user details

```sql
SELECT * FROM profiles
WHERE fid = ANY($1);
```

**Parameters**:

- `$1`: Array of FIDs

### 9. Search Profiles by Username

**Purpose**: Search users by username
**Usage**: User search functionality

```sql
SELECT * FROM profiles
WHERE data->>'username' ILIKE $1
ORDER BY last_updated_at
LIMIT $2;
```

**Parameters**:

- `$1`: Search query (with % wildcards)
- `$2`: Limit

### 10. Get User Followers

**Purpose**: Get list of user's followers
**Usage**: Social graph analysis

```sql
SELECT * FROM links
WHERE target_fid = $1 AND type = 'follow'
ORDER BY timestamp DESC
LIMIT $2;
```

**Parameters**:

- `$1`: User's FID
- `$2`: Limit (typically 50)

### 11. Get User Following

**Purpose**: Get list of users that a user follows
**Usage**: Social graph analysis

```sql
SELECT * FROM links
WHERE fid = $1 AND type = 'follow'
ORDER BY timestamp DESC
LIMIT $2;
```

**Parameters**:

- `$1`: User's FID
- `$2`: Limit (typically 50)

### 12. Get User Reactions

**Purpose**: Get all reactions made by a user
**Usage**: User activity analysis

```sql
SELECT * FROM reactions
WHERE fid = $1
ORDER BY timestamp DESC
LIMIT $2;
```

**Parameters**:

- `$1`: User's FID
- `$2`: Limit (typically 50)

### 13. Get User Verifications

**Purpose**: Get wallet verifications for a user
**Usage**: Displaying verified addresses

```sql
SELECT * FROM verifications
WHERE fid = $1
ORDER BY timestamp DESC;
```

**Parameters**:

- `$1`: User's FID

### 14. Get User Statistics

**Purpose**: Calculate comprehensive user statistics
**Usage**: Analytics and user insights

```sql
-- Total casts
SELECT count(*) FROM casts WHERE fid = $1;

-- Total replies
SELECT count(*) FROM casts
WHERE fid = $1 AND parent_cast_hash IS NOT NULL;

-- Follower count
SELECT count(*) FROM links
WHERE target_fid = $1 AND type = 'follow';

-- Following count
SELECT count(*) FROM links
WHERE fid = $1 AND type = 'follow';

-- Last activity
SELECT timestamp FROM casts
WHERE fid = $1
ORDER BY timestamp DESC
LIMIT 1;
```

**Parameters**:

- `$1`: User's FID

### 15. Search Casts by Text

**Purpose**: Full-text search across cast content
**Usage**: Content discovery

```sql
SELECT * FROM casts
WHERE text ILIKE $1
ORDER BY timestamp DESC
LIMIT $2;
```

**Parameters**:

- `$1`: Search query (with % wildcards)
- `$2`: Limit

## Performance Considerations

### Most Critical Query

The **main performance bottleneck** is the unreplied conversations query:

```sql
-- This executes 25+ times for a single API call
SELECT count(*) FROM casts
WHERE parent_cast_hash = $1
LIMIT 1;
```

### Optimization Opportunities

1. **Single JOIN Query**: Replace the two-step process with a single query using JOINs
2. **Composite Indexes**: Add indexes on frequently queried column combinations
3. **Materialized Views**: Consider materialized views for complex aggregations
4. **Query Caching**: Implement caching for frequently accessed data

### Recommended Indexes

```sql
-- Composite index for unreplied conversations
CREATE INDEX idx_casts_fid_parent_timestamp ON casts(fid, parent_cast_hash, timestamp)
WHERE parent_cast_hash IS NULL;

-- Index for reply counting
CREATE INDEX idx_casts_parent_hash_count ON casts(parent_cast_hash)
WHERE parent_cast_hash IS NOT NULL;
```

## API Endpoints Using These Queries

### Primary Endpoints

- `GET /api/farcaster-notification-replies` - Uses queries 1, 5, 6
- `GET /api/openRank` - External API, not database queries

### Secondary Endpoints

- `GET /api/farcaster-hub-conversation` - Uses queries 2, 4
- `GET /api/farcaster-hub-unreplied` - Uses queries 1, 5, 6

## Query Frequency

- **High Frequency**: Queries 1, 5, 6 (main app functionality)
- **Medium Frequency**: Queries 2, 3 (pagination)
- **Low Frequency**: Queries 7-15 (secondary features)

## Database Connection

- **Type**: PostgreSQL
- **ORM**: Drizzle ORM
- **Connection**: Read-only repository pattern
- **Pooling**: Managed by Drizzle connection pool
